<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>图片切图工具 (引导式下载版)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemSystemFont, "Segoe UI", sans-serif; background-color: #f4f7f9; color: #333; max-width: 900px; margin: 20px auto; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 10px; background: #fff; }
        h1, h2, h3 { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; padding: 20px; background-color: #ecf0f1; border-radius: 8px; margin-bottom: 20px; }
        input[type="file"] { display: none; }
        .file-label { background-color: #3498db; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        input[type="number"] { width: 60px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; text-align: center; }
        .action-button { color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
        #splitButton { background-color: #2ecc71; }
        #downloadControls { display: none; padding: 15px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #dee2e6; }
        #startDownloadButton { background-color: #e67e22; }
        .action-button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        #selectAllContainer { margin-bottom: 15px; font-weight: bold; }
        #fileList { list-style: none; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 5px; max-height: 150px; overflow-y: auto; }
        .output-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        .grid-item { position: relative; border: 1px solid #ddd; overflow: hidden; aspect-ratio: 1 / 1; }
        .grid-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .slice-checkbox { position: absolute; top: 8px; left: 8px; z-index: 10; width: 20px; height: 20px; cursor: pointer; }

        /* <<< 新增: 下载模态框样式 >>> */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: #fff; padding: 25px; border-radius: 12px; text-align: center; max-width: 350px; width: 90%; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-top: 0; font-size: 1.2rem; color: #333; }
        #modal-image-preview { max-width: 100%; max-height: 250px; height: auto; margin: 15px 0; border: 1px solid #eee; border-radius: 8px; }
        #modal-download-btn { width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; background-color: #28a745; }
        #modal-cancel-btn { width: 100%; padding: 10px; font-size: 0.9rem; margin-top: 10px; background-color: #6c757d; }
    </style>
</head>
<body>

    <h1>图片切图工具 (引导式下载版)</h1>
    <p style="text-align: center;">勾选图片，点击按钮，根据引导逐个下载，完美适配手机。</p>

    <div class="controls">
        <label for="imageLoader" class="file-label">1. 选择图片</label>
        <input type="file" id="imageLoader" accept="image/*">
        <label for="rows">2. 行数:</label> <input type="number" id="rows" value="3" min="1">
        <label for="cols">列数:</label> <input type="number" id="cols" value="3" min="1">
        <button id="splitButton" class="action-button">3. 开始切图</button>
    </div>

    <div id="downloadControls">
        <div id="selectAllContainer">
            <input type="checkbox" id="selectAllCheckbox"> <label for="selectAllCheckbox">全选 / 全不选</label>
        </div>
        <button id="startDownloadButton" class="action-button">开始下载选中项</button>
    </div>
    <div id="outputContainer"></div>
    <a id="hidden-download-link" style="display: none;"></a>

    <!-- <<< 新增: 下载模态框HTML >>> -->
    <div id="download-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-progress-text">准备下载...</h2>
            <img id="modal-image-preview" src="" alt="下载预览">
            <button id="modal-download-btn" class="action-button">下载</button>
            <button id="modal-cancel-btn" class="action-button">取消</button>
        </div>
    </div>

    <script>
        const imageLoader = document.getElementById('imageLoader');
        const rowsInput = document.getElementById('rows');
        const colsInput = document.getElementById('cols');
        const splitButton = document.getElementById('splitButton');
        const outputContainer = document.getElementById('outputContainer');
        const downloadControls = document.getElementById('downloadControls');
        const startDownloadButton = document.getElementById('startDownloadButton');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        
        // <<< 新增: 模态框元素 >>>
        const downloadModal = document.getElementById('download-modal');
        const modalProgressText = document.getElementById('modal-progress-text');
        const modalImagePreview = document.getElementById('modal-image-preview');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const hiddenLink = document.getElementById('hidden-download-link');

        let allSlicesData = [];
        let downloadQueue = [];
        let currentDownloadIndex = 0;

        function sanitizeFilename(name) { return name.replace(/[\/\\?%*:|"<>]/g, '_'); }
        
        splitButton.addEventListener('click', async () => {
            const file = imageLoader.files[0]; // 一次只处理一张图，保证手机性能
            if (!file) { alert('请先选择一张图片！'); return; }
            const rows = parseInt(rowsInput.value); const cols = parseInt(colsInput.value);
            if (isNaN(rows) || isNaN(cols) || rows <= 0 || cols <= 0) { alert('请输入有效的行数和列数！'); return; }
            
            outputContainer.innerHTML = ''; allSlicesData = [];
            splitButton.disabled = true; splitButton.textContent = '正在处理...';

            await processAndSplitImage(file, rows, cols);
            
            if (allSlicesData.length > 0) {
                downloadControls.style.display = 'block';
                selectAllCheckbox.checked = false;
            }
            splitButton.disabled = false; splitButton.textContent = '3. 开始切图';
        });

        async function processAndSplitImage(file, rows, cols) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0);

                    const baseFileName = sanitizeFilename(file.name.split('.').slice(0, -1).join('.'));
                    const sliceWidth = canvas.width / cols;
                    const sliceHeight = canvas.height / rows;

                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const sliceCanvas = document.createElement('canvas');
                            sliceCanvas.width = sliceWidth; sliceCanvas.height = sliceHeight;
                            sliceCanvas.getContext('2d').drawImage(canvas, c * sliceWidth, r * sliceHeight, sliceWidth, sliceHeight, 0, 0, sliceWidth, sliceHeight);
                            
                            const dataUrl = sliceCanvas.toDataURL('image/png');
                            const sliceName = `slice_${r + 1}_${c + 1}.png`;
                            allSlicesData.push({ dataUrl, downloadName: `${baseFileName}_${sliceName}` });

                            const gridItem = document.createElement('div'); gridItem.className = 'grid-item';
                            const imgElement = document.createElement('img'); imgElement.src = dataUrl;
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox'; checkbox.className = 'slice-checkbox';
                            gridItem.appendChild(checkbox); gridItem.appendChild(imgElement);
                            outputContainer.appendChild(gridItem);
                        }
                    }
                    resolve();
                };
                img.src = URL.createObjectURL(file);
                URL.revokeObjectURL(file); // 及时释放内存
            });
        }
        
        selectAllCheckbox.addEventListener('change', () => {
            document.querySelectorAll('.slice-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked);
        });

        // <<< 全新的下载流程 >>>
        startDownloadButton.addEventListener('click', () => {
            downloadQueue = [];
            document.querySelectorAll('.slice-checkbox').forEach((cb, index) => {
                if (cb.checked) {
                    downloadQueue.push(allSlicesData[index]);
                }
            });

            if (downloadQueue.length === 0) {
                alert('请至少勾选一张切片！');
                return;
            }

            currentDownloadIndex = 0;
            showNextInQueue();
            downloadModal.style.display = 'flex';
        });

        function showNextInQueue() {
            const currentSlice = downloadQueue[currentDownloadIndex];
            modalProgressText.textContent = `准备下载第 ${currentDownloadIndex + 1} / ${downloadQueue.length} 张`;
            modalImagePreview.src = currentSlice.dataUrl;

            // 准备隐藏的下载链接
            hiddenLink.href = currentSlice.dataUrl;
            hiddenLink.download = currentSlice.downloadName;

            if (currentDownloadIndex === downloadQueue.length - 1) {
                modalDownloadBtn.textContent = '下载最后一张并完成';
            } else {
                modalDownloadBtn.textContent = `下载第 ${currentDownloadIndex + 1} 张 & 继续`;
            }
        }

        modalDownloadBtn.addEventListener('click', () => {
            // 用户亲手点击，触发下载
            hiddenLink.click();
            
            currentDownloadIndex++;
            if (currentDownloadIndex < downloadQueue.length) {
                showNextInQueue();
            } else {
                downloadModal.style.display = 'none';
                alert('全部下载完成！');
            }
        });

        modalCancelBtn.addEventListener('click', () => {
            downloadModal.style.display = 'none';
        });

    </script>
</body>
</html>
