<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片切图工具 (iOS终极兼容版)</title>
    <!-- 引入打包必须的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/filesaver.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f9; color: #333; max-width: 900px; margin: 20px auto; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 10px; background: #fff; }
        h1, h2, h3 { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h3 { border-bottom: 1px dashed #95a5a6; margin-top: 40px; }
        .controls { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: center; padding: 20px; background-color: #ecf0f1; border-radius: 8px; margin-bottom: 20px; }
        input[type="file"] { display: none; }
        .file-label { background-color: #3498db; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .file-label:hover { background-color: #2980b9; }
        input[type="number"] { width: 60px; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; text-align: center; }
        .action-button { color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
        #splitButton { background-color: #2ecc71; }
        #splitButton:hover { background-color: #27ae60; }
        #downloadControls { display: none; padding: 15px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #dee2e6; }
        #downloadAllButton { background-color: #e67e22; }
        #downloadAllButton:hover { background-color: #d35400; }
        .action-button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        #selectAllContainer { margin-bottom: 15px; font-weight: bold; }
        #selectAllContainer input { margin-right: 8px; vertical-align: middle; }
        #fileList { list-style: none; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 5px; max-height: 150px; overflow-y: auto; }
        .output-grid { display: grid; gap: 10px; margin-top: 20px; }
        .grid-item { position: relative; border: 1px solid #ddd; overflow: hidden; }
        .grid-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .slice-checkbox { position: absolute; top: 8px; left: 8px; z-index: 10; width: 20px; height: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>图片切图工具 (iOS终极兼容版)</h1>
    <p style="text-align: center;">勾选需要的图片，一键打包为ZIP下载，完美适配苹果手机。</p>

    <div class="controls">
        <label for="imageLoader" class="file-label">1. 选择图片 (可多选)</label>
        <input type="file" id="imageLoader" accept="image/*" multiple>
        <label for="rows">2. 行数:</label>
        <input type="number" id="rows" value="3" min="1">
        <label for="cols">列数:</label>
        <input type="number" id="cols" value="3" min="1">
        <button id="splitButton" class="action-button" disabled>3. 开始切图</button>
    </div>

    <div class="preview-section" style="margin-top: 30px;">
        <h2>已选择的文件列表</h2>
        <ul id="fileList"><li>尚未选择任何文件</li></ul>
    </div>

    <div class="output-section" style="margin-top: 30px;">
        <h2>切图结果</h2>
        <div id="downloadControls">
            <div id="selectAllContainer">
                <input type="checkbox" id="selectAllCheckbox">
                <label for="selectAllCheckbox">全选 / 全不选</label>
            </div>
            <button id="downloadAllButton" class="action-button">打包下载选中项 (ZIP)</button>
        </div>
        <div id="outputContainer"></div>
    </div>

    <script>
        const imageLoader = document.getElementById('imageLoader');
        const fileList = document.getElementById('fileList');
        const rowsInput = document.getElementById('rows');
        const colsInput = document.getElementById('cols');
        const splitButton = document.getElementById('splitButton');
        const outputContainer = document.getElementById('outputContainer');
        const downloadControls = document.getElementById('downloadControls');
        const downloadAllButton = document.getElementById('downloadAllButton');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');

        let allSlicesData = []; // { sliceName, folderName, dataUrl }

        function sanitizeFilename(name) { return name.replace(/[\/\\?%*:|"<>]/g, '_'); }
        
        imageLoader.addEventListener('change', (e) => {
            const files = e.target.files; if (files.length === 0) return;
            allSlicesData = []; fileList.innerHTML = ''; outputContainer.innerHTML = '';
            downloadControls.style.display = 'none'; splitButton.disabled = true;
            splitButton.textContent = '加载图片中...';
            
            Array.from(files).forEach(file => {
                const listItem = document.createElement('li');
                listItem.textContent = file.name;
                fileList.appendChild(listItem);
            });
            
            splitButton.disabled = false;
            splitButton.textContent = '3. 开始切图';
        });

        splitButton.addEventListener('click', async () => {
            const files = imageLoader.files;
            if (files.length === 0) { alert('请先选择至少一张图片！'); return; }
            const rows = parseInt(rowsInput.value); const cols = parseInt(colsInput.value);
            if (isNaN(rows) || isNaN(cols) || rows <= 0 || cols <= 0) { alert('请输入有效的行数和列数！'); return; }
            
            outputContainer.innerHTML = ''; allSlicesData = [];
            splitButton.disabled = true; splitButton.textContent = '正在处理...';

            for (const file of files) {
                await processAndSplitImage(file, rows, cols);
            }
            
            if (allSlicesData.length > 0) {
                downloadControls.style.display = 'block';
                selectAllCheckbox.checked = false;
            }
            splitButton.disabled = false; splitButton.textContent = '3. 开始切图';
        });

        // 新增：智能缩放并切图的处理器
        async function processAndSplitImage(file, rows, cols) {
            const MAX_DIMENSION = 3000; // 为防止内存崩溃，设置一个最大尺寸
            
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let { width, height } = img;
                    let targetImage = img;
                    const canvas = document.createElement('canvas');

                    // 如果图片过大，进行智能缩放
                    if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
                        const ratio = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);
                        canvas.width = Math.round(width * ratio);
                        canvas.height = Math.round(height * ratio);
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // 创建一个新的Image对象来承载缩放后的图像
                        const resizedImg = new Image();
                        resizedImg.onload = () => {
                            splitImage(resizedImg, file.name, rows, cols);
                            resolve();
                        };
                        resizedImg.src = canvas.toDataURL(file.type);
                        return;
                    }
                    
                    // 如果图片尺寸合适，直接切图
                    splitImage(targetImage, file.name, rows, cols);
                    resolve();
                };
                img.src = URL.createObjectURL(file);
            });
        }
        
        function splitImage(sourceImage, originalName, rows, cols) {
            const resultWrapper = document.createElement('div');
            const resultTitle = document.createElement('h3'); resultTitle.textContent = `"${originalName}" 的切图结果`;
            const gridContainer = document.createElement('div'); gridContainer.className = 'output-grid';
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            resultWrapper.appendChild(resultTitle); resultWrapper.appendChild(gridContainer);
            outputContainer.appendChild(resultWrapper);
            
            const sliceWidth = sourceImage.width / cols;
            const sliceHeight = sourceImage.height / rows;
            const baseFileName = sanitizeFilename(originalName.split('.').slice(0, -1).join('.'));

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const canvas = document.createElement('canvas');
                    canvas.width = sliceWidth; canvas.height = sliceHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(sourceImage, c * sliceWidth, r * sliceHeight, sliceWidth, sliceHeight, 0, 0, sliceWidth, sliceHeight);
                    
                    const dataUrl = canvas.toDataURL('image/png');
                    const sliceName = `slice_${r + 1}_${c + 1}.png`;
                    
                    allSlicesData.push({ sliceName, folderName: baseFileName, dataUrl });

                    const gridItem = document.createElement('div'); gridItem.className = 'grid-item';
                    const imgElement = document.createElement('img'); imgElement.src = dataUrl;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'slice-checkbox';
                    
                    gridItem.appendChild(checkbox);
                    gridItem.appendChild(imgElement);
                    gridContainer.appendChild(gridItem);
                }
            }
        }
        
        selectAllCheckbox.addEventListener('change', () => {
            document.querySelectorAll('.slice-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked);
        });

        downloadAllButton.addEventListener('click', async () => {
            const checkedSlicesIndices = [];
            document.querySelectorAll('.slice-checkbox').forEach((cb, index) => {
                if (cb.checked) checkedSlicesIndices.push(index);
            });

            if (checkedSlicesIndices.length === 0) {
                alert('请至少勾选一张切片进行下载！');
                return;
            }

            downloadAllButton.disabled = true;
            downloadAllButton.textContent = '正在打包...';

            try {
                const zip = new JSZip();
                const useFolders = imageLoader.files.length > 1;

                for (const index of checkedSlicesIndices) {
                    const slice = allSlicesData[index];
                    const base64Data = slice.dataUrl.split(',')[1];
                    const fileName = `${slice.folderName}_${slice.sliceName}`;

                    if (useFolders) {
                        zip.folder(slice.folderName).file(slice.sliceName, base64Data, { base64: true });
                    } else {
                        zip.file(fileName, base64Data, { base64: true });
                    }
                }
                
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "image_slices.zip");

            } catch (error) {
                console.error("打包失败:", error);
                alert("打包ZIP文件时出错。");
            } finally {
                downloadAllButton.disabled = false;
                downloadAllButton.textContent = '打包下载选中项 (ZIP)';
            }
        });
    </script>
</body>
</html>
